<div class="modal fade" id="xrayModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content glass-panel border-0 p-0">
            <div class="modal-header border-0 border-bottom border-secondary p-4">
                <div class="d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3 border border-primary border-opacity-25">
                        <i class="fas fa-microchip fa-2x text-primary-neon"></i>
                    </div>
                    <div>
                        <h4 class="modal-title fw-bold text-white ls-2">NEW <span class="text-primary-neon">CONFIG</span></h4>
                        <small class="text-white-50 font-monospace">PROTOCOL & NETWORK SETUP</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-4" style="max-height: 80vh; overflow-y: auto;">
                <form id="xrayForm">
                    <div class="glass-card p-4 mb-4 border-start border-4 border-primary">
                        <h6 class="text-primary-neon small fw-bold mb-3">BASE CONFIGURATION</h6>
                        <div class="row g-4">
                            <div class="col-md-3">
                                <label class="text-muted small fw-bold">PROTOCOL</label>
                                <select id="protocol_select" class="form-select bg-dark text-white" onchange="updateXrayUI()">
                                    <option value="vless">VLESS</option>
                                    <option value="vmess">VMess</option>
                                    <option value="trojan">Trojan</option>
                                    <option value="shadowsocks">Shadowsocks</option>
                                    <option value="wireguard">WireGuard</option>
                                    <option value="dokodemo-door">Dokodemo-door</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="text-muted small fw-bold">NAME (REMARK)</label>
                                <input id="remark" class="form-control" placeholder="Config-Name">
                            </div>
                            <div class="col-md-2">
                                <label class="text-muted small fw-bold">PORT</label>
                                <input id="port" type="number" class="form-control" value="443">
                            </div>
                            <div class="col-md-2">
                                <label class="text-muted small fw-bold">LISTEN IP</label>
                                <input id="listen_ip" class="form-control" value="0.0.0.0" placeholder="0.0.0.0">
                            </div>
                            <div class="col-md-2">
                                <label class="text-muted small fw-bold">TOTAL GB</label>
                                <input id="total_gb" type="number" class="form-control" placeholder="0 = Unl">
                            </div>
                        </div>
                    </div>

                    <div id="protocol_container">
                        
                        <div class="proto-box d-none" id="box_vless">
                            <div class="glass-card p-4 border-start border-4 border-info">
                                <h6 class="text-info small fw-bold mb-3">VLESS SETTINGS</h6>
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label class="text-muted small">UUID</label>
                                        <div class="input-group">
                                            <input id="vless_uuid" class="form-control font-monospace text-warning">
                                            <button type="button" class="btn btn-outline-secondary" onclick="generateUUID('vless_uuid')"><i class="fas fa-sync"></i></button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="text-muted small">FLOW</label>
                                        <select id="vless_flow" class="form-select">
                                            <option value="">None</option>
                                            <option value="xtls-rprx-vision" selected>xtls-rprx-vision</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="proto-box d-none" id="box_vmess">
                            <div class="glass-card p-4 border-start border-4 border-warning">
                                <h6 class="text-warning small fw-bold mb-3">VMESS SETTINGS</h6>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="text-muted small">UUID</label>
                                        <div class="input-group">
                                            <input id="vmess_uuid" class="form-control font-monospace text-warning">
                                            <button type="button" class="btn btn-outline-secondary" onclick="generateUUID('vmess_uuid')"><i class="fas fa-sync"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="proto-box d-none" id="box_trojan">
                            <div class="glass-card p-4 border-start border-4 border-light">
                                <h6 class="text-white small fw-bold mb-3">TROJAN PASSWORD</h6>
                                <input id="trojan_password" class="form-control" placeholder="MyStrongPassword">
                            </div>
                        </div>

                        <div class="proto-box d-none" id="box_shadowsocks">
                            <div class="glass-card p-4 border-start border-4 border-success">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="text-muted small">METHOD</label>
                                        <select id="ss_method" class="form-select">
                                            <option value="aes-128-gcm">aes-128-gcm</option>
                                            <option value="aes-256-gcm">aes-256-gcm</option>
                                            <option value="2022-blake3-aes-128-gcm">2022-blake3-aes-128-gcm</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8">
                                        <label class="text-muted small">PASSWORD</label>
                                        <input id="ss_password" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        </div>

                    <div class="glass-card p-4 mt-4" id="stream_settings_box">
                        <h6 class="text-secondary small fw-bold mb-3">TRANSPORT & SECURITY</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="text-muted small">NETWORK</label>
                                <select id="net_type" class="form-select" onchange="updateTransportFields()">
                                    <option value="tcp">TCP</option>
                                    <option value="ws">WebSocket (WS)</option>
                                    <option value="grpc">gRPC</option>
                                    <option value="xhttp">XHTTP</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small">SECURITY</label>
                                <select id="sec_type" class="form-select" onchange="updateSecurityFields()">
                                    <option value="none">None</option>
                                    <option value="tls">TLS</option>
                                    <option value="reality">REALITY</option>
                                </select>
                            </div>
                        </div>

                        <div id="trans_fields" class="mt-3 p-3 border border-secondary border-opacity-25 rounded d-none">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="text-muted small">PATH / SERVICE NAME</label>
                                    <input id="trans_path" class="form-control" placeholder="/path or serviceName" value="/">
                                </div>
                                <div class="col-md-4">
                                    <label class="text-muted small">HOST</label>
                                    <input id="trans_host" class="form-control" placeholder="host.com">
                                </div>
                            </div>
                        </div>

                        <div id="sec_fields_reality" class="mt-3 p-3 border border-success border-opacity-25 rounded d-none">
                            <h6 class="text-success small fw-bold">REALITY CONFIG</h6>
                            <div class="row g-2">
                                <div class="col-md-6"><input id="rea_dest" class="form-control" placeholder="Dest (yahoo.com:443)"></div>
                                <div class="col-md-6"><input id="rea_sni" class="form-control" placeholder="SNI (yahoo.com)"></div>
                                <div class="col-md-12">
                                    <div class="input-group">
                                        <input id="rea_key" class="form-control font-monospace" placeholder="Private Key">
                                        <button type="button" class="btn btn-outline-success" onclick="alert('Generate on backend')">GEN</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                         <div id="sec_fields_tls" class="mt-3 p-3 border border-warning border-opacity-25 rounded d-none">
                            <h6 class="text-warning small fw-bold">TLS CONFIG</h6>
                            <div class="row g-2">
                                <div class="col-md-12"><input id="tls_crt" class="form-control" placeholder="Cert Path"></div>
                                <div class="col-md-12"><input id="tls_key" class="form-control" placeholder="Key Path"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-glass w-100 py-3 fw-bold shadow-lg" onclick="deployConfig()">
                    <i class="fas fa-rocket me-2"></i>DEPLOY CONFIGURATION
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- UI Logic ---
    function updateXrayUI() {
        const proto = document.getElementById('protocol_select').value;
        
        // Hide all proto boxes
        document.querySelectorAll('.proto-box').forEach(el => el.classList.add('d-none'));
        
        // Show selected
        const box = document.getElementById(`box_${proto}`);
        if(box) box.classList.remove('d-none');
        
        // Stream settings toggle
        const streamBox = document.getElementById('stream_settings_box');
        if(['wireguard', 'dokodemo-door'].includes(proto)) {
            streamBox.classList.add('d-none');
        } else {
            streamBox.classList.remove('d-none');
        }
        
        // Generate UUID automatically if empty
        if(proto === 'vless' && !document.getElementById('vless_uuid').value) generateUUID('vless_uuid');
        if(proto === 'vmess' && !document.getElementById('vmess_uuid').value) generateUUID('vmess_uuid');
    }

    function updateTransportFields() {
        const net = document.getElementById('net_type').value;
        const fieldBox = document.getElementById('trans_fields');
        if (['ws', 'grpc', 'xhttp', 'httpupgrade'].includes(net)) {
            fieldBox.classList.remove('d-none');
        } else {
            fieldBox.classList.add('d-none');
        }
    }

    function updateSecurityFields() {
        const sec = document.getElementById('sec_type').value;
        document.getElementById('sec_fields_reality').classList.add('d-none');
        document.getElementById('sec_fields_tls').classList.add('d-none');
        
        if (sec === 'reality') document.getElementById('sec_fields_reality').classList.remove('d-none');
        if (sec === 'tls') document.getElementById('sec_fields_tls').classList.remove('d-none');
    }

    function generateUUID(targetId) {
        const uuid = crypto.randomUUID();
        document.getElementById(targetId).value = uuid;
    }

    // --- Main Logic: Collect & Send ---
    async function deployConfig() {
        const btn = document.querySelector('button[onclick="deployConfig()"]');
        btn.disabled = true;
        btn.innerHTML = "DEPLOYING...";

        try {
            // 1. Base Info
            const protocol = document.getElementById('protocol_select').value;
            const payload = {
                base: {
                    remark: document.getElementById('remark').value || `Node-${document.getElementById('port').value}`,
                    protocol: protocol,
                    port: parseInt(document.getElementById('port').value),
                    listen: document.getElementById('listen_ip').value || "0.0.0.0", // ایپی پیش‌فرض
                    total: parseInt(document.getElementById('total_gb').value) || 0,
                },
                settings: {},
                stream: {},
                sniffing: { enabled: true, destOverride: ["http", "tls", "quic"] }
            };

            // 2. Protocol Specifics
            if (protocol === 'vless') {
                payload.settings = {
                    clients: [{
                        id: document.getElementById('vless_uuid').value,
                        flow: document.getElementById('vless_flow').value
                    }],
                    decryption: "none"
                };
            } else if (protocol === 'vmess') {
                payload.settings = {
                    clients: [{
                        id: document.getElementById('vmess_uuid').value,
                        alterId: 0
                    }]
                };
            } else if (protocol === 'trojan') {
                payload.settings = {
                    clients: [{
                        password: document.getElementById('trojan_password').value
                    }]
                };
            } else if (protocol === 'shadowsocks') {
                payload.settings = {
                    method: document.getElementById('ss_method').value,
                    password: document.getElementById('ss_password').value,
                    network: "tcp,udp"
                };
            }

            // 3. Stream Settings (If applicable)
            if (!['wireguard', 'dokodemo-door'].includes(protocol)) {
                const net = document.getElementById('net_type').value;
                const sec = document.getElementById('sec_type').value;
                
                payload.stream = {
                    network: net,
                    security: sec,
                    sockopt: { mark: 0, tcpFastOpen: true }
                };

                // Network Details
                if (net === 'ws') {
                    payload.stream.wsSettings = {
                        path: document.getElementById('trans_path').value,
                        headers: { Host: document.getElementById('trans_host').value }
                    };
                } else if (net === 'grpc') {
                    payload.stream.grpcSettings = {
                        serviceName: document.getElementById('trans_path').value,
                        multiMode: true
                    };
                }

                // Security Details
                if (sec === 'reality') {
                    payload.stream.realitySettings = {
                        show: false,
                        dest: document.getElementById('rea_dest').value,
                        serverNames: [document.getElementById('rea_sni').value],
                        privateKey: document.getElementById('rea_key').value,
                        shortIds: [""]
                    };
                } else if (sec === 'tls') {
                    payload.stream.tlsSettings = {
                        certificates: [{
                            certificateFile: document.getElementById('tls_crt').value,
                            keyFile: document.getElementById('tls_key').value
                        }]
                    };
                }
            }

            // 4. Send to Backend
            console.log("Sending Payload:", payload); // برای دیباگ

            const response = await fetch('/core/add-inbound', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            
            if (result.status === 'success') {
                window.location.reload();
            } else {
                alert("Error: " + result.message);
            }

        } catch (e) {
            alert("Client Error: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = "DEPLOY CONFIGURATION";
        }
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        updateXrayUI();
        updateTransportFields();
        updateSecurityFields();
    });
</script>