<div class="modal fade" id="xrayModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <form id="xrayForm" class="modal-content glass-panel border-0 p-0">
            <div class="modal-header border-0 border-bottom border-secondary p-4">
                <div class="d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3 border border-primary border-opacity-25">
                        <i class="fas fa-network-wired fa-2x text-primary-neon"></i>
                    </div>
                    <div>
                        <h4 class="modal-title fw-bold text-white ls-2">XRAY <span class="text-primary-neon">MASTER</span></h4>
                        <small class="text-white-50 font-monospace">FULL PROTOCOL SUITE (v1.8.24+)</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-4" style="max-height: 80vh; overflow-y: auto;">
                
                <div class="glass-card p-4 mb-4 border-start border-4 border-primary">
                    <div class="row g-4">
                        <div class="col-md-3">
                            <label class="text-primary-neon small fw-bold">PROTOCOL</label>
                            <select name="protocol" class="form-select bg-dark text-white" id="protocolSelect" onchange="updateXrayUI()">
                                <option value="vless">VLESS (Recommended)</option>
                                <option value="vmess">VMess</option>
                                <option value="trojan">Trojan</option>
                                <option value="shadowsocks">Shadowsocks 2022</option>
                                <option value="dokodemo-door">Dokodemo-door</option>
                                <option value="wireguard">WireGuard</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small fw-bold">REMARK</label>
                            <input name="remark" class="form-control" placeholder="Config-Name">
                        </div>
                        <div class="col-md-2">
                            <label class="text-muted small fw-bold">PORT</label>
                            <input name="port" type="number" class="form-control" value="443">
                        </div>
                        <div class="col-md-2">
                            <label class="text-muted small fw-bold">LISTEN IP</label>
                            <input name="listen" class="form-control font-monospace" value="0.0.0.0">
                        </div>
                        <div class="col-md-2">
                            <label class="text-muted small fw-bold">QUOTA (GB)</label>
                            <input name="total" type="number" class="form-control" placeholder="0 = Unlimited">
                        </div>
                    </div>
                </div>

                <div id="protocolSettings" class="mb-4">
                    <div class="protocol-section d-none" data-proto="vless">
                        <div class="glass-card p-4 border-start border-4 border-info">
                            <h6 class="text-info small fw-bold mb-3">VLESS CONFIGURATION</h6>
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="text-muted small">UUID</label>
                                    <div class="input-group">
                                        <input name="vless_id" class="form-control font-monospace" id="vless_uuid">
                                        <button type="button" class="btn btn-outline-info" onclick="genUUID('vless_uuid')"><i class="fas fa-sync"></i></button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="text-muted small">FLOW (XTLS)</label>
                                    <select name="vless_flow" class="form-select">
                                        <option value="">None</option>
                                        <option value="xtls-rprx-vision" selected>xtls-rprx-vision</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="protocol-section d-none" data-proto="vmess">
                        <div class="glass-card p-4 border-start border-4 border-warning">
                            <h6 class="text-warning small fw-bold mb-3">VMESS CONFIGURATION</h6>
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="text-muted small">UUID</label>
                                    <div class="input-group">
                                        <input name="vmess_id" class="form-control font-monospace" id="vmess_uuid">
                                        <button type="button" class="btn btn-outline-warning" onclick="genUUID('vmess_uuid')"><i class="fas fa-sync"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="protocol-section d-none" data-proto="trojan">
                        <div class="glass-card p-4 border-start border-4 border-light">
                            <h6 class="text-white small fw-bold mb-3">TROJAN PASSWORD</h6>
                            <input name="auth_user" class="form-control" placeholder="StrongPassword">
                        </div>
                    </div>

                    <div class="protocol-section d-none" data-proto="shadowsocks">
                        <div class="glass-card p-4 border-start border-4 border-success">
                            <h6 class="text-success small fw-bold mb-3">SHADOWSOCKS 2022</h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="text-muted small">METHOD</label>
                                    <select name="ss_method" class="form-select">
                                        <option value="2022-blake3-aes-128-gcm">2022-blake3-aes-128-gcm</option>
                                        <option value="aes-128-gcm">aes-128-gcm</option>
                                        <option value="chacha20-ietf-poly1305">chacha20-ietf-poly1305</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="text-muted small">PASSWORD</label>
                                    <input name="ss_password" class="form-control font-monospace">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion" id="streamAccordion">
                    <div class="accordion-item glass-card bg-transparent">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed text-primary-neon fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStream">
                                <i class="fas fa-layer-group me-2"></i> STREAM & TRANSPORT SETTINGS
                            </button>
                        </h2>
                        <div id="collapseStream" class="accordion-collapse collapse show" data-bs-parent="#streamAccordion">
                            <div class="accordion-body">
                                
                                <div class="row g-3 mb-4">
                                    <div class="col-md-4">
                                        <label class="text-muted small fw-bold">NETWORK</label>
                                        <select name="stream_network" class="form-select" id="netSelect" onchange="updateTransportFields()">
                                            <option value="tcp">TCP (RAW)</option>
                                            <option value="xhttp">XHTTP (Recommended)</option>
                                            <option value="ws">WebSocket</option>
                                            <option value="grpc">gRPC</option>
                                            <option value="httpupgrade">HTTPUpgrade</option>
                                            <option value="kcp">mKCP</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="text-muted small fw-bold">SECURITY</label>
                                        <select name="stream_security" class="form-select" id="secSelect" onchange="updateSecurityFields()">
                                            <option value="none">None</option>
                                            <option value="tls">TLS</option>
                                            <option value="reality">REALITY</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="transportFields" class="p-3 bg-black bg-opacity-25 rounded border border-secondary border-opacity-10 mb-3">
                                    
                                    <div class="trans-section d-none" data-trans="ws httpupgrade">
                                        <div class="row g-3">
                                            <div class="col-md-8"><label class="small text-muted">PATH</label><input name="trans_path" class="form-control" value="/"></div>
                                            <div class="col-md-4"><label class="small text-muted">HOST</label><input name="trans_host" class="form-control" placeholder="domain.com"></div>
                                        </div>
                                    </div>

                                    <div class="trans-section d-none" data-trans="grpc">
                                        <div class="row g-3">
                                            <div class="col-md-8"><label class="small text-muted">SERVICE NAME</label><input name="grpc_service" class="form-control" value="grpc"></div>
                                            <div class="col-md-4 pt-4">
                                                <div class="form-check form-switch">
                                                    <input name="grpc_multi" type="checkbox" class="form-check-input"> <label class="form-check-label text-white small">Multi Mode</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="trans-section d-none" data-trans="xhttp">
                                        <h6 class="text-primary-neon small fw-bold mb-2">XHTTP SETTINGS</h6>
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label class="small text-muted">MODE</label>
                                                <select name="xhttp_mode" class="form-select form-select-sm">
                                                    <option value="auto">Auto</option>
                                                    <option value="packet-up">Packet Up</option>
                                                    <option value="stream-up">Stream Up</option>
                                                </select>
                                            </div>
                                            <div class="col-md-5"><label class="small text-muted">PATH</label><input name="trans_path" class="form-control" value="/"></div>
                                            <div class="col-md-4"><label class="small text-muted">EXTRA (JSON)</label><input name="xhttp_extra" class="form-control form-control-sm" placeholder='{"noGRPCHeader": false}'></div>
                                        </div>
                                    </div>
                                </div>

                                <div id="securityFields" class="p-3 bg-black bg-opacity-25 rounded border border-secondary border-opacity-10 mb-3">
                                    
                                    <div class="sec-section d-none" data-sec="tls">
                                        <h6 class="text-warning small fw-bold">TLS CERTIFICATES</h6>
                                        <div class="row g-3">
                                            <div class="col-md-6"><input name="tls_cert" class="form-control" placeholder="Fullchain Path"></div>
                                            <div class="col-md-6"><input name="tls_key" class="form-control" placeholder="Private Key Path"></div>
                                        </div>
                                    </div>

                                    <div class="sec-section d-none" data-sec="reality">
                                        <h6 class="text-success small fw-bold">REALITY STEALTH</h6>
                                        <div class="row g-3">
                                            <div class="col-md-12">
                                                <div class="input-group">
                                                    <span class="input-group-text bg-dark border-success text-success">KEY</span>
                                                    <input name="reality_key" class="form-control font-monospace" placeholder="Private Key">
                                                    <button type="button" class="btn btn-outline-success" onclick="alert('Generate on server!')">GEN</button>
                                                </div>
                                            </div>
                                            <div class="col-md-6"><input name="reality_dest" class="form-control" placeholder="google.com:443"></div>
                                            <div class="col-md-6"><input name="reality_snis" class="form-control" placeholder="SNI (comma separated)"></div>
                                            <div class="col-md-6"><input name="reality_shortids" class="form-control" placeholder="ShortIDs"></div>
                                            <div class="col-md-6">
                                                <select name="reality_fingerprint" class="form-select">
                                                    <option value="chrome">Chrome</option>
                                                    <option value="firefox">Firefox</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="p-3 bg-black bg-opacity-25 rounded border border-secondary border-opacity-10">
                                    <h6 class="text-white-50 small fw-bold mb-2">KERNEL OPTIONS (SOCKOPT)</h6>
                                    <div class="row g-2">
                                        <div class="col-md-3"><input name="tcp_bbr" class="form-control form-control-sm" placeholder="Congestion (bbr)"></div>
                                        <div class="col-md-3"><input name="tcp_mark" type="number" class="form-control form-control-sm" placeholder="Mark"></div>
                                        <div class="col-md-6 d-flex align-items-center gap-3">
                                            <div class="form-check form-switch"><input name="tfo" type="checkbox" class="form-check-input"> <span class="small">TFO</span></div>
                                            <div class="form-check form-switch"><input name="mptcp" type="checkbox" class="form-check-input"> <span class="small">MPTCP</span></div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-glass w-100 py-3 fw-bold shadow-lg" onclick="submitXrayConfig()">
                    <i class="fas fa-rocket me-2"></i>DEPLOY CONFIGURATION
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function updateXrayUI() {
        const proto = document.getElementById('protocolSelect').value;
        document.querySelectorAll('.protocol-section').forEach(el => el.classList.add('d-none'));
        const section = document.querySelector(`.protocol-section[data-proto~="${proto}"]`);
        if(section) section.classList.remove('d-none');
        
        // Auto UUID
        if(proto === 'vless' && !document.getElementById('vless_uuid').value) genUUID('vless_uuid');
        if(proto === 'vmess' && !document.getElementById('vmess_uuid').value) genUUID('vmess_uuid');
    }

    function updateTransportFields() {
        const net = document.getElementById('netSelect').value;
        document.querySelectorAll('.trans-section').forEach(el => el.classList.add('d-none'));
        const section = document.querySelector(`.trans-section[data-trans~="${net}"]`);
        if(section) section.classList.remove('d-none');
    }

    function updateSecurityFields() {
        const sec = document.getElementById('secSelect').value;
        document.querySelectorAll('.sec-section').forEach(el => el.classList.add('d-none'));
        const section = document.querySelector(`.sec-section[data-sec~="${sec}"]`);
        if(section) section.classList.remove('d-none');
    }

    function genUUID(id) {
        document.getElementById(id).value = crypto.randomUUID();
    }

    function submitXrayConfig() {
        // استفاده از تابع موجود در main.js شما یا فراخوانی مستقیم fetch
        // اینجا فرض میکنیم تابع startInstall در main.js هست و به cores.py وصل میشه
        startInstall('xray_advanced', 'xrayForm');
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateXrayUI();
        updateTransportFields();
        updateSecurityFields();
    });
</script>